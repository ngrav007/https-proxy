#!/bin/bash

# Test 05: GET Request, URI to Binary File, to HTTPS website

# Import test config
CONFIG=$(dirname $0)/.test-config.conf
# Import test config
if [ -f ${CONFIG} ]; then
    . ${CONFIG}
else
    echo "[-] Error: .config.conf not found!"
    exit 1
fi

# Test Setup
METHOD="GET"
URL="/~dga/dga-headshot.jpg"
HOST="www.cs.cmu.edu"
SLEEPTIME="5"

# File and Directory Setup
TESTNAME=$(basename $0)
FETCH_OUT="$REPORT_DIR/$TESTNAME-$FETCH-$OUTPUT_EXT"
CACHE_OUT="$REPORT_DIR/$TESTNAME-$CACHE-$OUTPUT_EXT"
FETCH_REPORT="$REPORT_DIR/$TESTNAME-$FETCH-$REPORT_EXT"
CACHE_REPORT="$REPORT_DIR/$TESTNAME-$CACHE-$REPORT_EXT"

echo "+ ---------- $TESTNAME: $METHOD Request, URI, HTTPS --------- +"

echo "[*] Sending Request:"
echo " |    $METHOD $URL HTTP/1.1"
echo " |    Host: $HOST"

echo "[*] Sending initial request to $URL..."
fetch=$($TIMER $TIMER_FLAGS $FETCH_REPORT $CLIENT $CLIENT_FLAGS $METHOD $HOST $URL 2> $FETCH_OUT)
echo "[*] Sleeping for $SLEEPTIME seconds..."
for i in {1..$SLEEPTIME}; do
    echo -n "."
    sleep 1
done

echo ""
echo "[*] Sending second request to $URL..."
cache=$($TIMER $TIMER_FLAGS $CACHE_REPORT $CLIENT $CLIENT_FLAGS $METHOD $HOST $URL 2> $CACHE_OUT)

FETCH_RESULTS=$(cat $FETCH_REPORT)
CACHE_RESULTS=$(cat $CACHE_REPORT)

echo "[+] $TESTNAME Results ----------------------------------------------- +"
echo ""
echo "[*] Time Elapsed w/ Fetch: "
echo ""
echo "$FETCH_RESULTS"
echo ""
echo "[*] Time Elapsed w/ Cache: "
echo ""
echo "$CACHE_RESULTS"
echo ""
echo "+ --------------------------------------------------------- +"
